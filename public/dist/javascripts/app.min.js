var imagePath="http://zhuhaolin.com/images/",myApp=angular.module("myApp",["ui.router","ngAnimate","infinite-scroll","appRoutes","homeCtrl","playStationCtrl","playStationService","gameCtrl","gameService","gourmetCtrl","gourmetService"]);myApp.run(function($rootScope,$state,$http,Game){$http.defaults.headers.common.auth="ljpon3UUVTMMmIhE6Kcf",$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$rootScope.bodyClass=$state.current.controller,"game"==toState.name?Game.get(toParams.url).success(function(data){$rootScope.title=data.name+"_PlayStation"}):$rootScope.title=$state.current.title})}),angular.module("appRoutes",[]).config(function($stateProvider,$urlRouterProvider,$locationProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"/views/index.html",controller:"homeController",title:"Home"}).state("playstation",{url:"/playstation",templateUrl:"/views/playstation.html",controller:"playStationController",title:"PlayStation"}).state("game",{url:"/playstation/:url",templateUrl:"/views/game.html",controller:"gameController",title:"Game"}).state("gourmet",{url:"/gourmet",templateUrl:"/views/gourmet/gourmet.html",controller:"gourmetController",title:"Gourmet"}),$locationProvider.html5Mode(!0)});var gameCtrl=angular.module("gameCtrl",[]);gameCtrl.controller("gameController",function($scope,$stateParams,Game){Game.get($stateParams.url).success(function(data){$scope.imagePath=imagePath,$scope.game=data,$scope.descriptions=data.description.split("\n"),$scope.rate=data.rate;var rateText=["Terrible","Poor","Fair","Good","Great"];$scope.rateText=rateText[data.rate-1];var companies=data.company.split("/");"1"==companies.length?($scope.developer=data.company,$scope.publish=data.company):($scope.developer=companies[0],$scope.publish=companies[1])})}),gameCtrl.directive("ngGame",["$timeout",function(timer){return{restrict:"A",scope:{rate:"=gameRate"},replace:!0,link:function(scope,attr,element){function drawRate(rate){var bgCanvas=$("#rateBackground")[0],bgContext=bgCanvas.getContext("2d"),alpha=0,drawBackground=setInterval(function(){alpha+=.05,alpha>1&&clearInterval(drawBackground),bgContext.clearRect(0,0,100,100),bgContext.fillStyle="rgba(255, 255, 255, "+alpha+")",bgContext.beginPath(),bgContext.arc(50,50,45,0,2*Math.PI,!0),bgContext.closePath(),bgContext.fill()},50);setTimeout(function(){bgContext.font="Bold 50px Arial",bgContext.textAlign="center",bgContext.fillStyle="#ff0000",bgContext.textBaseline="middle",bgContext.fillText(rate,50,50)},1100);var rateCanvas=$("#rate")[0],rateContext=rateCanvas.getContext("2d"),degree=0,drawRateCircle=setInterval(function(){degree++,degree>360*rate/5-90&&clearInterval(drawRateCircle),rateContext.clearRect(0,0,100,100),rateContext.beginPath(),rateContext.arc(50,50,40,-(.5*Math.PI),Math.PI/180*degree,!1),rateContext.lineWidth=10,rateContext.strokeStyle="#ff0000",rateContext.stroke()})}function gamePageLoading(){var pageLoading=$("[data-game='pageLoading']"),gameDetail=$("[data-game='detail']"),gameImage=$("[data-game='image']"),src=gameImage.attr("src"),image=new Image;$(image).attr("src",src).bind("load",function(){pageLoading.dimmer("hide").removeClass("active"),gameDetail.transition("show"),setTimeout(drawRate(scope.rate),300)})}timer(gamePageLoading,500)}}}]);var gourmetCtrl=angular.module("gourmetCtrl",[]);gourmetCtrl.controller("gourmetController",function($scope,Gourmets){$scope.imagePath=imagePath,$scope.busy=!0,Gourmets.get().success(function(data){var gourmetsData=data.reverse(),length=gourmetsData.length;$scope.gourmets=gourmetsData.splice(0,24),$scope.loadMore=function(){if($scope.busy=!0,0===length)return!1;var num=12;num>length&&(num=length);var moreGourmets=gourmetsData.splice(0,num);angular.forEach(moreGourmets,function(value){$scope.gourmets.push(value)})}}),$scope.getDate=function(timestamp){var newDate=new Date(timestamp),months=["January","February","March","April","May","June","July","August","September","October","November","December"],year=newDate.getFullYear(),month=months[newDate.getMonth()],day=newDate.getDate(),date=day+" "+month+" "+year;return date}}),gourmetCtrl.directive("ngGourmet",["$timeout",function(timer){return{restrict:"A",replace:!0,scope:{val:"=gourmetsModel",busy:"=scrollBusy"},link:function(scope,element,attrs){var progressBar=$("[data-gourmet='progressBar']"),circleLoading=$("[data-gourmet='circleLoading']"),initLoading=function(){var item=$("[data-gourmet='item']"),length=item.length,count=0;item.each(function(){var itemImage=$("[data-gourmet='itemImage']",$(this)),src=$(itemImage).attr("src"),image=new Image;$(image).attr("src",src).bind("load",function(){count++;var value=Math.round(count/length*100);progressBar.children().css("width",value+"%").attr("aria-valuenow",value).text(value+"%"),count==length&&(progressBar.addClass("fadeOut"),item.css("display","block").attr("data-visible",1),setTimeout(function(){item.addClass("fadeIn"),circleLoading.css("display","block").addClass("fadeIn"),scope.busy=!1,scope.$apply()},350))})})},loadMore=function(){var invisibleItem=$("[data-gourmet='item'][data-visible='0']"),length=invisibleItem.length,count=0;console.log(length),scope.busy=!0,scope.$apply(),invisibleItem.each(function(){var itemImage=$("[data-gourmet='itemImage']",$(this)),src=$(itemImage).attr("src"),image=new Image;$(image).attr("src",src).bind("load",function(){count++,count==length&&(circleLoading.addClass("fadeOut"),setTimeout(function(){circleLoading.css("display","none"),invisibleItem.css("display","block"),setTimeout(function(){invisibleItem.addClass("fadeIn").attr("data-visible",1),12==length&&circleLoading.css("display","block").removeClass("fadeOut").addClass("fadeIn"),scope.busy=!1,scope.$apply()},100)},350))})})};scope.$watch("val",function(newValue,oldValue){oldValue?newValue&&timer(loadMore,200):timer(initLoading,200)},!0)}}}]);var homeCtrl=angular.module("homeCtrl",[]);homeCtrl.controller("homeController",function($scope,$state){$scope.imagePath=imagePath}),homeCtrl.directive("ngHome",["$timeout",function(timer){return{restrict:"A",replace:!0,link:function(scope,element,attrs){var fullPageContainer=$("[data-full-page='container']"),fullPageSection=$("[data-full-page='section']"),fullPageSectionLength=fullPageSection.length,windowHeight=$(window).height();fullPageSection.each(function(){var sectionHeight=$(this).height();$(this).css({"padding-top":(windowHeight-sectionHeight)/2-100,height:windowHeight})}),fullPageContainer.on("mousewheel",function(event){var direction=event.deltaY,style=window.getComputedStyle($(this)[0],null),matrix=new WebKitCSSMatrix(style.webkitTransform);-100>direction&&matrix.m42%windowHeight===0&&matrix.m42!=-windowHeight*(fullPageSectionLength-1)?$(this).css("transform","translate(0, "+(matrix.m42-windowHeight)+"px)"):direction>100&&matrix.m42%windowHeight===0&&0!==matrix.m42&&$(this).css("transform","translate(0, "+(matrix.m42+windowHeight)+"px)")});var image=new Image,src=imagePath+"73ad5a84dcefe956276f1bd07c6316dd.jpg",pageLoading=$("[data-index='pageLoading']");$(image).attr("src",src).bind("load",function(){pageLoading.dimmer("hide").removeClass("active"),fullPageContainer.transition("fade")})}}}]);var playStationCtrl=angular.module("playStationCtrl",[]);playStationCtrl.controller("playStationController",function($scope,Games){$scope.imagePath=imagePath,$scope.busy=!0,Games.get().success(function(data){var gamesData=data.reverse(),length=gamesData.length;$scope.gamesLength=length,$scope.games=gamesData.splice(0,24),$scope.loadMore=function(){if($scope.busy=!0,0===length)return!1;var num=12;num>length&&(num=length);var moreGames=gamesData.splice(0,num);angular.forEach(moreGames,function(value){$scope.games.push(value)})}}),$scope.getNumber=function(num){return new Array(num)}}),playStationCtrl.directive("ngPlayStation",["$timeout",function(timer){return{restrict:"A",replace:!0,scope:{val:"=gamesModel",total:"=gamesLength",busy:"=scrollBusy"},link:function(scope,element,attrs){function imageLoading(obj,callback){var itemImage=$("[data-playstation='itemImage']",obj),src=itemImage.attr("src"),image=new Image;$(image).attr("src",src).bind("load",function(){callback()})}function itemVisible(item,progress,callback){var count=0;item.each(function(){var itemInfo=$("[data-playstation='itemInfo']",$(this));itemInfo.dimmer({on:"hover"}),imageLoading($(this),function(){count++,progress&&progress.progress("increment"),count==item.length&&(item.attr("data-status",1).removeClass("hidden"),scope.busy=!1,scope.$apply(),callback&&callback())})})}function initLoading(){var progressDimmer=$("[data-playstation='progressDimmer']"),progress=$("[data-playstation='progress']"),item=$("[data-playstation='item']");itemVisible(item,progress,function(){progressDimmer.dimmer("hide").removeClass("active"),list.transition("fade")})}function moreLoading(){var item=$("[data-playstation='item'][data-status='0']");itemVisible(item,null,function(){var visibleItem=$("[data-playstation='item'][data-status='1']"),moreLoader=$("[data-playstation='moreLoader']");visibleItem.length===scope.total&&moreLoader.addClass("hidden")})}var list=$("[data-playstation='list']");list.transition("fade"),scope.$watch("val",function(newValue,oldValue){oldValue?newValue&&timer(moreLoading,0):timer(initLoading,0)},!0)}}}]);var gameService=angular.module("gameService",[]);gameService.factory("Game",function($http){return{get:function(game_url){return $http.get("/api/game/"+game_url)}}});var gourmetService=angular.module("gourmetService",[]);gourmetService.factory("Gourmets",function($http){return{get:function(){return $http.get("/api/gourmets")}}});var playStationService=angular.module("playStationService",[]);playStationService.factory("Games",function($http){return{get:function(){return $http.get("/api/games")}}});